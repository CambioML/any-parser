import os
import sys

from dotenv import load_dotenv

sys.path.append(".")
sys.path.append("..")
sys.path.append("../..")

from any_parser import AnyParser  # noqa: E402

if __name__ == "__main__":
    load_dotenv()

    example_apikey = os.getenv("CAMBIO_API_KEY")

    example_local_file = "./sample_data/test2.pdf"

    op = AnyParser(example_apikey)

    print("file/document extraction test:")
    content_result = op.extract(example_local_file)
    print(type(content_result))
    print(content_result)

    print("information extraction test:")
    qa_result = op.parse(example_local_file)
    print(type(qa_result))
    print(qa_result)

    print("instruction extraction test:")
    example_prompt = "Return table under Investor Metrics in JSON format with year as the key and the column as subkeys."
    instruction_result = op.instruct(example_local_file, prompt=example_prompt)
    print(type(instruction_result))
    print(instruction_result)

    example_local_file = "./sample_data/test_schema.pdf"
    params = {
        "md_info": [],  # list: empty or parsed pdf markdown
        "db_schema": None,  # None or parsed db schema list
        "sample_mapping": None,  # None or parsed sample mapping dict
        "info_table_names": [],  # list: empty or parsed info table names list
        "target_table": None,  # None or target table name string
        "required_keys": [],  # list: empty or required keys list
    }
    # without parsed markdown
    print("schema extraction test:")
    schema_result = op.schema(example_local_file, custom_schema=params)
    print(type(schema_result))
    print(schema_result)

    # with parsed markdown, the open parser will not re-redner and parse the pdf again
    params["md_info"] = [
        "# derayah\n\n## Derayah Global\n\n### Activity Statement\n\n*June 27, 2023*\n\n## Account Information\n\n| Name | faten Alrajhi |\n| --- | --- |\n| Account Alias | 1057889 |\n| Account | U3071571 |\n| Master Name | Derayah Financial Company (FBO Clients) |\n| Account Type | Broker Client |\n| Customer Type | Individual |\n| Account Capabilities | Margin |\n| Base Currency | USD |\n\n## Net Asset Value\n\n| | June 26, 2023 | June 27, 2023 | Total | Change |\n| --- | --- | --- | --- | --- |\n| Cash | 21,616.92 | 29,388.08 | 29,388.08 | 7,771.16 |\n| Stock | 421,677.85 | 360,201.80 | 360,201.80 | -61,476.06 |\n| Dividend Accruals | 0.28 | 0.28 | 0.28 | 0.00 |\n| Total | 443,295.05 | 389,590.16 | 389,590.16 | -53,704.89 |\nTime Weighted Rate of Return: -12.11%\n\n## Change in NAV\n| | Total |\n| --- | --- |\n| Starting Value | 443,295.05 |\n| Mark-to-Market | -51,943.64 |\n| Commissions | -1,531.53 |\n| Transaction Fees | -229.73 |\n| Ending Value | 389,590.16 |\n\n## Mark-to-Market Performance Summary\n\n| Symbol | Prior | Current | Prior | Current | Position | Transaction | Commissions | Other | Total | Code |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| Stocks | | | | | | | | | | |\n| 1833 | 5,000 | 5,000 | 18.9400 | 19.3000 | 229.77 | 0.00 | 0.00 | 0.00 | 229.77 | |\n| AHT | 1 | 1 | 3.4800 | 3.4700 | -0.01 | 0.00 | 0.00 | 0.00 | -0.01 | |\n| AMC | 1 | 1 | 4.0300 | 4.1000 | 0.07 | 0.00 | 0.00 | 0.00 | 0.07 | |\n| APE | 1 | 1 | 1.8000 | 1.7800 | -0.02 | 0.00 | 0.00 | 0.00 | -0.02 | |\n| ARVL | 13,381.24 | 3,381.24 | 2.2700 | 2.6400 | 4,951.06 | 629.12 | -149.50 | 0.00 | 5,430.68 | |\n| BYND | 1 | 1 | 11.9500 | 12.4100 | 0.46 | 0.00 | 0.00 | 0.00 | 0.46 | |\n| CCL | 1 | 1 | 14.6000 | 15.8900 | 1.29 | 0.00 | 0.00 | 0.00 | 1.29 | |\n| CLVSQ | 1 | 1 | 0.019135 | 0.019525 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | |\n| DADA | 1 | 1 | 5.6000 | 5.5600 | -0.04 | 0.00 | 0.00 | 0.00 | -0.04 | |\n| DM | 1,000 | 1,000 | 1.8600 | 1.8700 | 10.00 | 0.00 | 0.00 | 0.00 | 10.00 | |\n| DOYU | 10,000 | 10,000 | 1.0100 | 1.0400 | 300.00 | 0.00 | 0.00 | 0.00 | 300.00 | |\n| HUYA | 500 | 500 | 3.6000 | 3.7000 | 50.00 | 0.00 | 0.00 | 0.00 | 50.00 | |\n| HYZN | 20,000 | 10,000 | 0.7720 | 0.9501 | 3,562.00 | -385.00 | -149.50 | 0.00 | 3,027.50 | |\n\nGenerated: 2023-07-02, 03:20:45 EDT\n\nPage: 1",
        "Realized & Unrealized Performance Summary\n\n| Symbol | Cost Adj. | S/T Profit | S/T Loss | Realized L/T Profit | L/T Loss | Total | S/T Profit | S/T Loss | Unrealized L/T Profit | L/T Loss | Total | Total | Code |\n|:-------|:----------|:-----------|:---------|:-------------------|:---------|:------|:-----------|:---------|:---------------------|:---------|:------|:------|:-----|\n| LCID | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -303.35 | 0.00 | 0.00 | -303.35 | -303.35 |\n| LI | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 11.94 | 0.00 | 11.94 | 11.94 |\n| LPRO | 0.00 | 7,139.71 | 0.00 | 0.00 | 0.00 | 7,139.71 | 3.54 | 0.00 | 0.00 | 0.00 | 3.54 | 7,143.24 |\n| MULN | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -13,763,335.31 | 0.00 | 0.00 | -13,763,335.31 | -13,763,335.31 |\n| NIO | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -1,544.95 | 0.00 | 0.00 | -1,544.95 | -1,544.95 |\n| NKLA | 0.00 | 0.00 | -12,149.10 | 0.00 | 0.00 | -12,149.10 | 0.00 | -1,299.95 | 0.00 | 0.00 | -1,299.95 | -13,449.05 |\n| NVAX | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -10.15 | 0.00 | 0.00 | -10.15 | -10.15 |\n| RIVN | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -2.98 | 0.00 | 0.00 | -2.98 | -2.98 |\n| SEV | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -6,293.07 | 0.00 | -2.84 | -6,295.90 | -6,295.90 |\n| SQQQ | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -21.41 | 0.00 | 0.00 | -21.41 | -21.41 |\n| TOM2a | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -2,522.72 | -2,522.72 | -2,522.72 |\n| TQQQ | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 19.62 | 0.00 | 0.00 | 0.00 | 19.62 | 19.62 |\n| U | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 11.36 | 0.00 | 0.00 | 0.00 | 11.36 | 11.36 |\n| UVXY | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -5.21 | 0.00 | 0.00 | -5.21 | -5.21 |\n| VIXY | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -15.19 | -15.19 | -15.19 |\n| VXX | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -18.79 | -18.79 | -18.79 |\n| WISH | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -3,554.59 | 0.00 | 0.00 | -3,554.59 | -3,554.59 |\n| WKHS | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -3,206.32 | 0.00 | 0.00 | -3,206.32 | -3,206.32 |\n| Total Stocks | 0.00 | 7,139.71 | -192,720.76 | 0.00 | 0.00 | -185,581.05 | 2,870.01 | -13,844,486.85 | 11.94 | -4,379.67 | -13,845,984.58 | -14,031,565.63 |\n| Forex |||||||||||||\n| HKD | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 |\n| Total Forex | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 |\n| Total (All Assets) | 0.00 | 7,139.71 | -192,720.76 | 0.00 | 0.00 | -185,581.05 | 2,870.01 | -13,844,486.85 | 11.94 | -4,379.67 | -13,845,984.58 | -14,031,565.63 |\n\n## Cash Report\n\n| | Total | Securities | Futures |\n|:------------------------------|:----------|:-------------|:----------|\n| Base Currency Summary ||||\n| Starting Cash | 21,616.92 | 21,616.92 | 0.00 |\n| Commissions | -1,531.53 | -1,531.53 | 0.00 |\n| Trades (Sales) | 66,242.94 | 66,242.94 | 0.00 |\n| Trades (Purchase) | -56,710.52 | -56,710.52 | 0.00 |\n| Transaction Fees | -229.73 | -229.73 | 0.00 |\n| Cash FX Translation Gain/Loss | 0.00 | 0.00 | 0.00 |\n| Ending Cash | 29,388.08 | 29,388.08 | 0.00 |\n| Ending Settled Cash | 20,085.39 | 20,085.39 | 0.00 |\n\nOpen Positions\n\n| Symbol | Quantity | Mult | Cost Price | Cost Basis | Close Price | Value | Unrealized P/L | Code |\n|:-------|:---------|:-----|:-----------|:-----------|:------------|:------|:----------------|:-----|\n| Stocks |||||||||\n\nActivity Statement June 27, 2023\n\nPage: 3",
        "|                     |           |    |             |               |          |            |                |\n|:--------------------|:----------|:---|:------------|:--------------|:---------|:-----------|:---------------|\n| Open Positions      |           |    |             |               |          |            |                |\n| EUR                 |           |    |             |               |          |            |                |\n| TOM2a               | 675       | 1  | 10.0900     | 6,810.75      | 6.6800   | 4,509.00   | -2,301.75      |\n| Total               |           |    |             | 6,810.75      |          | 4,509.00   | -2,301.75      |\n|                     |           |    |             |               |          |            |                |\n| Total in USD        |           |    |             | 7,464.58      |          | 4,941.86   | -2,522.72      |\n| HKD                 |           |    |             |               |          |            |                |\n| 1833                | 5,000     | 1  | 15.03856541 | 75,192.83     | 19.3000  | 96,500.00  | 21.307,17      |\n| Total               |           |    |             | 75,192.83     |          | 96,500.00  | 21,307.17      |\n|                     |           |    |             |               |          |            |                |\n| Total in USD        |           |    |             | 9,598.36      |          | 12,318.23  | 2,719.86       |\n| USD                 |           |    |             |               |          |            |                |\n| AHT                 | 1         | 1  | 5.38495     | 5.38          | 3.4700   | 3.47       | -1,91          |\n| AMC                 | 1         | 1  | 7.362003    | 7.36          | 4.1000   | 4.10       | -3.26          |\n| APE                 | 1         | 1  | 1.64495     | 1.64          | 1.7800   | 1.78       | 0.14           |\n| ARVL                | 3,381.24  | 1  | 18.99214718 | 64,217.01     | 2.6400   | 8,926.47   | -55,290.54     |\n| BYND                | 1         | 1  | 14.12495    | 14.12         | 12.4100  | 12.41      | -1,71          |\n| CCL                 | 1         | 1  | 8.24495     | 8.24          | 15.8900  | 15.89      | 7.65           |\n| CLVSQ               | 1         | 1  | 0.291522    | 0.29          | 0.019525 | 0.02       | -0.27          |\n| DADA                | 1         | 1  | 5.22495     | 5.22          | 5.5600   | 5.56       | 0.34           |\n| DM                  | 1,000     | 1  | 3.68495     | 3,684.95      | 1.8700   | 1,870.00   | -1,814.95      |\n| DOYU                | 10,000    | 1  | 1.30495     | 13,049.50     | 1.0400   | 10,400.00  | -2,649.50      |\n| HUYA                | 500       | 1  | 3.48495     | 1,742.48      | 3.7000   | 1,850.00   | 107.52         |\n| HYZN                | 10,000    | 1  | 1.646852    | 16,468.52     | 0.9501   | 9,501.00   | -6,967.52      |\n| LCID                | 1,000     | 1  | 6.40335     | 6,403.35      | 6.1000   | 6,100.00   | -303.35        |\n| LI                  | 1         | 1  | 22.77495    | 22.77         | 34.7100  | 34.71      | 11.94          |\n| LPRO                | 1         | 1  | 6.67495     | 6.67          | 10.2100  | 10.21      | 3.54           |\n| MULN                | 2,100,000 | 1  | 6.6907692   | 14,050,615.31 | 0.1368   | 287,280.00 | -13,763,335.31 |\n| NIO                 | 1,000     | 1  | 10.88495    | 10,884.95     | 9.3400   | 9,340.00   | -1,544.95      |\n| NKLA                | 1,000     | 1  | 2.39995     | 2,399.95      | 1.1000   | 1,100.00   | -1,299.95      |\n| NVAX                | 1         | 1  | 17.23495    | 17.23         | 7.0800   | 7.08       | -10.15         |\n| RIVN                | 1         | 1  | 16.92495    | 16.92         | 13.9400  | 13.94      | -2.98          |\n| SEV                 | 10,000    | 1  | 0.90799022  | 9,079.90      | 0.2784   | 2,784.00   | -6,295.90      |\n| SQQQ                | 1         | 1  | 41.19495    | 41.19         | 19.7800  | 19.78      | -21.41         |\n| TQQQ                | 1         | 1  | 19.64495    | 19.64         | 39.2600  | 39.26      | 19.62          |\n| U                   | 1         | 1  | 31.02495    | 31.02         | 42.3800  | 42.38      | 11.36          |\n| UVXY                | 0.1       | 1  | 71.5995     | 7.16          | 19.5000  | 1.95       | -5.21          |\n| VIXY                | 0.2       | 1  | 101.77475   | 20.35         | 25.8100  | 5.16       | -15.19         |\n| VXX                 | 0.25      | 1  | 100.931004  | 25.23         | 25.7700  | 6.44       | -18.79         |\n| WISH                | 333.3333  | 1  | 17.7737743  | 5,924.59      | 7.1100   | 2,370.00   | -3,554.59      |\n| WKHS                | 1,500     | 1  | 2.93495     | 4,402.42      | 0.7974   | 1,196.10   | -3,206.32      |\n| Total               |           |    |             | 14,189,123.43 |          | 342,941.71 | -13,846,181.72 |\n|                     |           |    |             |               |          |            |                |\n| Total Stocks in USD |           |    |             | 14,206,186.38 |          | 360,201.80 | -13,845,984.58 |\n\n|        |           |          |          |          |          |          |       |              |         |      |\n|:-------|:----------|:---------|:---------|:---------|:---------|:---------|:------|:-------------|:--------|:-----|\n| Trades |           |          |          |          |          |          |       |              |         |      |\n| Symbol | Date/Time | Quantity | T. Price | C. Price | Proceeds | Comm/Fee | Basis | Realized P/L | MTM P/L | Code |\n\nActivity Statement June 27, 2023\n\nPage: 4",
        "|            |                      |         |             |         |            |           |             |             |           |     |\n|:-----------|:---------------------|:--------|:------------|:--------|:-----------|:----------|:------------|:------------|:----------|:----|\n| Trades     |                      |         |             |         |            |           |             |             |           |     |\n| Stocks     |                      |         |             |         |            |           |             |             |           |     |\n| USD        |                      |         |             |         |            |           |             |             |           |     |\n| ARVL       | 2023-06-27, 14:00:30 | -10,000 | 2.702912    | 2.6400  | 27,029.12  | -149.50   | -200,213.02 | -173,333.40 | 629.12    | C;P |\n| Total ARVL |                      | -10,000 |             |         | 27,029.12  | -149.50   | -200,213.02 | -173,333.40 | 629.12    |     |\n| HYZN       | 2023-06-27, 13:58:50 | -10,000 | 0.9116      | 0.9501  | 9,116.00   | -149.50   | -16,204.76  | -7,238.26   | -385.00   | C   |\n| Total HYZN |                      | -10,000 |             |         | 9,116.00   | -149.50   | -16,204.76  | -7,238.26   | -385.00   |     |\n| LPRO       | 2023-06-27, 13:54:49 | -1,999  | 10.26154077 | 10.2100 | 20,512.82  | -29.89    | -13,343.23  | 7,139.71    | 103.03    | C;P |\n| Total LPRO |                      | -1,999  |             |         | 20,512.82  | -29.89    | -13,343.23  | 7,139.71    | 103.03    |     |\n| MULN       | 2023-06-27, 13:55:37 | 6,000   | 0.1398      | 0.1368  | -838.80    | -19.20    | 858.00      | 0.00        | -18.00    | O;P |\n| MULN       | 2023-06-27, 13:55:48 | 10,000  | 0.1398      | 0.1368  | -1,398.00  | -31.99    | 1,429.99    | 0.00        | -30.00    | O;P |\n| MULN       | 2023-06-27, 13:56:01 | 20,000  | 0.1395      | 0.1368  | -2,790.00  | -63.85    | 2,853.85    | 0.00        | -54.00    | O;P |\n| MULN       | 2023-06-27, 13:56:35 | 20,000  | 0.1398      | 0.1368  | -2,796.00  | -63.99    | 2,859.99    | 0,00        | -60.00    | O;P |\n| MULN       | 2023-06-27, 13:56:57 | 50,000  | 0.1404914   | 0.1368  | -7,024.57  | -160.76   | 7,185.33    | 0.00        | -184.57   | O;P |\n| MULN       | 2023-06-27, 13:57:39 | 50,000  | 0.1409      | 0.1368  | -7,045.00  | -161.22   | 7,206.22    | 0.00        | -205.00   | O;P |\n| MULN       | 2023-06-27, 13:58:00 | 50,000  | 0.14092558  | 0.1368  | -7,046.28  | -161.25   | 7,207.53    | 0.00        | -206.28   | O;P |\n| MULN       | 2023-06-27, 13:59:27 | 10,000  | 0.1407      | 0.1368  | -1,407.00  | -32.20    | 1,439.20    | 0.00        | -39.00    | O;P |\n| MULN       | 2023-06-27, 14:00:48 | 40,000  | 0.14004825  | 0.1368  | -5,601.93  | -128.20   | 5,730.13    | 0.00        | -129.93   | O;P |\n| MULN       | 2023-06-27, 14:00:59 | 10,000  | 0.1399      | 0.1368  | -1,399.00  | -32.02    | 1,431.02    | 0.00        | -31.00    | O;P |\n| MULN       | 2023-06-27, 14:01:55 | 40,000  | 0.1397165   | 0.1368  | -5,588.66  | -127.90   | 5,716.56    | 0.00        | -116.66   | O;P |\n| MULN       | 2023-06-27, 14:04:28 | 10,000  | 0.1395      | 0.1368  | -1,395.00  | -31.92    | 1,426.92    | 0.00        | -27.00    | O;P |\n| MULN       | 2023-06-27, 14:18:52 | 40,000  | 0.13802553  | 0.1368  | -5,521.02  | -126.35   | 5,647.37    | 0.00        | -49.02    | O;P |\n| MULN       | 2023-06-27, 14:41:41 | 50,000  | 0.1371852   | 0.1368  | -6,859.26  | -156.97   | 7,016.23    | 0.00        | -19.26    | O;P |\n| Total MULN |                      | 406,000 |             |         | -56,710.52 | -1,297.82 | 58,008.34   | 0.00        | -1,169.72 |     |\n| NKLA       | 2023-06-27, 13:55:14 | -9,000  | 1.0650      | 1.1000  | 9,585.00   | -134.55   | -21,599.55  | -12,149.10  | -315.00   | C   |\n| Total NKLA |                      | -9,000  |             |         | 9,585.00   | -134.55   | -21,599.55  | -12,149.10  | -315.00   |     |\n| Total      |                      |         |             |         | 9,532.42   | -1,761.26 | -193,352.21 | -185,581.05 | -1,137.57 |     |\n\nTransaction Fees\n\n| Date/Time            | Symbol   | Description        | Quantity   | Trade Price   | Amount   | Code   |\n|:---------------------|:---------|:-------------------|:-----------|:--------------|:---------|:-------|\n| Stocks               |          |                    |            |               |          |        |\n| USD                  |          |                    |            |               |          |        |\n| 2023-06-27, 13:54:49 | LPRO     | SA Value Added Tax | -100       | 10.2650       | -0.20    |        |\n| 2023-06-27, 13:54:49 | LPRO     | SA Value Added Tax | -100       | 10.2600       | -0.20    |        |\n| 2023-06-27, 13:54:49 | LPRO     | SA Value Added Tax | -500       | 10.2610       | -0.98    |        |\n\nActivity Statement June 27. 2023\n\nPage: 5",
    ]
    print("schema extraction test 2:")
    schema_result = op.schema(example_local_file, custom_schema=params)
    print(type(schema_result))
    print(schema_result)
